name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    format:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Check formatting
              run: |
                find include tests -name '*.hpp' -o -name '*.cpp' | xargs clang-format --dry-run --Werror

    build-and-test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                build_type: [Debug, Release]
        steps:
            - uses: actions/checkout@v4

            - name: Configure
              run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

            - name: Build
              run: cmake --build build

            - name: Test
              run: ctest --test-dir build --output-on-failure
    
    sanitizers:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                sanitizer:
                    - { name: ASan, flags: "-DENABLE_ASAN=ON" }
                    - { name: UBSan, flags: "-DENABLE_UBSAN=ON" }
                    - { name: TSan, flags: "-DENABLE_TSAN=ON" }
        steps:
            - uses: actions/checkout@v4

            - name: Configure (${{ matrix.sanitizer.name }})
              run: cmake -B build -DCMAKE_BUILD_TYPE=Debug ${{ matrix.sanitizer.flags }}

            - name: Build
              run: cmake --build build

            - name: Test
              run: ctest --test-dir build --output-on-failure
